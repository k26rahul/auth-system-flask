<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Todo App</title>
    <style>
      main,
      form,
      label {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      main {
        max-width: 400px;
        margin: 1rem auto;
        font-family: sans-serif;
      }

      label {
        flex-direction: row;
        justify-content: space-between;
      }
    </style>
  </head>
  <body>
    <main>
      <!-- Login accordion -->
      <details>
        <summary>Login</summary>
        <form id="login-form">
          <label>
            Email:
            <input type="text" id="email" value="rahul@example.com" />
          </label>
          <label>
            Password:
            <input type="text" id="password" value="12345" />
          </label>
          <button>Login</button>
        </form>
      </details>

      <div id="auth-result">Not logged in</div>

      <button onclick="fetchTodos()">Fetch all todos</button>

      <ul id="todos"></ul>
    </main>

    <script>
      const html = String.raw;

      let sessionId = localStorage.getItem('sessionId');
      let token = localStorage.getItem('token');

      if (sessionId && token) {
        document.querySelector('#auth-result').textContent = 'Already logged in';
      }

      document.querySelector('form').addEventListener('submit', handleLogin);

      async function handleLogin(event) {
        event.preventDefault();

        const res = await fetch('http://127.0.0.1:5000/auth/login', {
          method: 'post',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            email: document.querySelector('#email').value,
            password: document.querySelector('#password').value,
          }),
        });

        const data = await res.json();

        if (data.success) {
          console.log(data);
          sessionId = data.payload.session_id;
          token = data.payload.token;
          localStorage.setItem('sessionId', sessionId);
          localStorage.setItem('token', token);
        } else {
          console.error(data);
        }

        document.querySelector('#auth-result').textContent = data.message;
      }

      async function fetchTodos() {
        const res = await fetch('http://127.0.0.1:5000/todo/list?session_id=1&token=a5nRTFj11j');
        const data = await res.json();

        if (data.success) {
          console.log(data);
          for (let todo of data.payload.todos) {
            const todoHtml = html`<li>${todo.text}</li>`;
            // document.querySelector('#todos').innerHTML += todoHtml;
            document.querySelector('#todos').insertAdjacentHTML('beforeend', todoHtml);
          }
        } else {
          console.error(data);
        }
      }
    </script>
  </body>
</html>
